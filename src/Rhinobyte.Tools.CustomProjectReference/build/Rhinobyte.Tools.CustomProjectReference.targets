<?xml version="1.0" encoding="utf-8"?>
<Project>

    <PropertyGroup>
        <!-- Explicitly set these to either true orfalse so we can use them direclty as boolean expressions below -->
        <IsMultiTargeted Condition="'$(TargetFrameworks)' != '' AND $(TargetFrameworks.IndexOf(';')) &gt; -1 AND $(TargetFrameworks.IndexOf(';')) != $([MSBuild]::Add($(TargetFrameworks.Length), 1))">true</IsMultiTargeted>
        <IsInnerBuild Condition="'$(IsInnerBuild)' == '' AND '$(IsMultiTargeted)' == 'true' AND '$(TargetFramework)' != ''">true</IsInnerBuild>
    </PropertyGroup>

    <PropertyGroup Condition="'$(IsInnerBuild)' != 'true'">
        <_ProcessBeforeBuildRunOnlyOnce Condition=" '$(_ProcessBeforeBuildRunOnlyOnce)' == '' AND $(IsMultiTargeted)">DispatchToInnerBuilds</_ProcessBeforeBuildRunOnlyOnce>
        <_ProcessBeforeBuildRunOnlyOnce Condition=" '$(_ProcessBeforeBuildRunOnlyOnce)' == '' AND !$(IsMultiTargeted)">BeforeBuild</_ProcessBeforeBuildRunOnlyOnce>

        <_ProcessCustomProjectReferencesBeforeTargets Condition=" '$(_ProcessCustomProjectReferencesBeforeTargets)' != '' ">$(_ProcessCustomProjectReferencesBeforeTargets);$(_ProcessBeforeBuildRunOnlyOnce)</_ProcessCustomProjectReferencesBeforeTargets>
        <_ProcessCustomProjectReferencesBeforeTargets Condition=" '$(_ProcessCustomProjectReferencesBeforeTargets)' == '' ">$(_ProcessBeforeBuildRunOnlyOnce)</_ProcessCustomProjectReferencesBeforeTargets>

        <AssignTargetPathsDependsOn Condition="'$(AssignTargetPathsDependsOn)' != ''">
            $(AssignTargetPathsDependsOn);
            _ProcessCustomProjectReferences;
        </AssignTargetPathsDependsOn>
        <AssignTargetPathsDependsOn Condition="'$(AssignTargetPathsDependsOn)' == ''">_ProcessCustomProjectReferences</AssignTargetPathsDependsOn>
    </PropertyGroup>

    <Target Name="_ProcessCustomProjectReferences"
            BeforeTargets="$(_ProcessCustomProjectReferencesBeforeTargets)"
            DependsOnTargets="$(_ProcessCustomProjectReferencesDependsOnTargets)"
            Inputs="@(CustomProjectReference)"
            Outputs="@(CustomProjectReference->'$(IntermediateOutputPath)%(RecursiveDir)%(Identity).cache')"
    >
        <Message Importance="high" Text="
  !! _ProcessCustomProjectReferences !!

MSBuildVersion:        $(MSBuildVersion)
MSBuildToolsVersion:   $(MSBuildToolsVersion)

IsMultiTargeted:  $(IsMultiTargeted)
IsInnerBuild:     $(IsInnerBuild)

_ProcessBeforeBuildRunOnlyOnce:                  $(_ProcessBeforeBuildRunOnlyOnce)
_ProcessCustomProjectReferencesBeforeTargets:       $(_ProcessCustomProjectReferencesBeforeTargets)
_ProcessCustomProjectReferencesDependsOnTargets:    $(_ProcessCustomProjectReferencesDependsOnTargets)

TargetFramework:   $(TargetFramework)
TargetFrameworks:  $(TargetFrameworks)

CustomProjectReferences:
@(CustomProjectReference->'$(IntermediateOutputPath)%(RecursiveDir)%(Identity).cache%0a')

" />
    </Target>
</Project>